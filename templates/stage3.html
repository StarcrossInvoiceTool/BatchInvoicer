<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Editing: Edit Saved Invoice - Batch Invoicer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-4 py-8">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-2xl p-8 mb-6">
            <div class="mb-6">
                <div class="mb-2">
                    <a href="/" class="text-blue-600 hover:text-blue-800 text-sm mb-2 inline-block">← Back to Home</a>
                </div>
                <div class="mb-2">
                    <a href="#" id="back-to-previous-btn" class="text-blue-600 hover:text-blue-800 text-sm mb-4 inline-block hidden">← Back to Previous Page</a>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Invoice Editing: Edit Saved Invoice</h1>
                <p class="text-gray-600">Upload a saved HTML invoice draft, edit invoice details, and regenerate the invoice</p>
            </div>

            <!-- HTML Upload Section -->
            <div id="upload-section" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="html_file" class="block text-sm font-medium text-gray-700 mb-2">
                            Select HTML Invoice File
                        </label>
                        <input 
                            type="file" 
                            id="html_file" 
                            name="file"
                            accept=".html"
                            required
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"
                        >
                        <p class="mt-2 text-xs text-gray-500">Upload a saved HTML invoice draft to edit</p>
                    </div>
                    <button 
                        type="submit"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200"
                    >
                        Upload and Parse HTML Invoice
                    </button>
                </form>
            </div>

            <div id="loading" class="hidden text-center py-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                <p class="mt-2 text-gray-600">Processing HTML invoice...</p>
            </div>

            <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <p class="text-red-800 text-sm"></p>
            </div>
        </div>

        <!-- Invoice Editing Section (hidden initially) -->
        <div id="editing-section" class="hidden bg-white rounded-lg shadow-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Edit Invoice Details</h2>
                    <p id="current-invoice-name" class="text-sm text-gray-500 mt-1"></p>
                </div>
            </div>
            
            <form id="invoice-form">
                <!-- Client Information -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Client Information</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                            <input type="text" id="patient-name" name="patient_name" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client Postcode</label>
                            <input type="text" id="patient-postcode" name="patient_postcode" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client Address</label>
                            <textarea id="patient-address" name="patient_address" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Press Enter for new lines"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Invoice Header Information -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Invoice Header</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
                            <input type="text" id="invoice-number" name="invoice_number" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Date</label>
                            <input type="date" id="invoice-date" name="invoice_date" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Account Reference</label>
                            <input type="text" id="account-ref" name="account_ref" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Reference</label>
                            <input type="text" id="ref" name="ref" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PO Number</label>
                            <input type="text" id="po-number" name="po_number" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Terms</label>
                            <input type="text" id="payment-terms" name="payment_terms" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Period</label>
                            <input type="text" id="period" name="period" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                    </div>
                </div>

                <!-- Financial Information -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Financial Information</h3>
                    <div class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                                <input type="text" id="net-label" name="net_label" value="net" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Value</label>
                                <input type="number" step="0.01" id="net" name="net" class="w-full border border-gray-300 rounded-lg px-4 py-2" oninput="calculateSubtotalAndVAT()">
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                                <input type="text" id="discount-label" name="discount_label" value="discount" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Value</label>
                                <input type="number" step="0.01" id="discount" name="discount" class="w-full border border-gray-300 rounded-lg px-4 py-2" oninput="calculateSubtotalAndVAT()">
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                                <input type="text" id="subtotal-label" name="subtotal_label" value="Invoice subtotal" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Value</label>
                                <input type="number" step="0.01" id="subtotal" name="subtotal" class="w-full border border-gray-300 rounded-lg px-4 py-2" readonly>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                                <input type="text" id="vat-label" name="vat_label" value="VAT" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Percentage (%)</label>
                                <input type="number" step="0.01" id="vat-percentage" name="vat_percentage" value="20" class="w-full border border-gray-300 rounded-lg px-4 py-2" oninput="calculateVAT()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Value</label>
                                <input type="number" step="0.01" id="vat-amount" name="vat_amount" class="w-full border border-gray-300 rounded-lg px-4 py-2" readonly>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                                <input type="text" id="total-label" name="total_label" value="TOTAL DUE" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Value</label>
                                <input type="number" step="0.01" id="total" name="total" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bank Details -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Bank Details (Static)</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bank Name</label>
                            <input type="text" id="bank-name" name="bank_name" value="Lloyds Bank Plc" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-100 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Account Name</label>
                            <input type="text" id="bank-account-name" name="bank_account_name" value="Starcross Trading Limited" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-100 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Account Number</label>
                            <input type="text" id="bank-account-number" name="bank_account_number" value="82082760" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-100 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sort Code</label>
                            <input type="text" id="bank-sort-code" name="bank_sort_code" value="30-99-21" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-100 cursor-not-allowed">
                        </div>
                    </div>
                </div>

                <!-- Invoice Style Selection -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Invoice Style</h3>
                    <div class="space-y-4">
                        <div class="flex items-center gap-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <input 
                                type="radio" 
                                id="style1-radio" 
                                name="invoice-style" 
                                value="style1"
                                checked
                                class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500"
                                onchange="toggleStyleOptions()"
                            >
                            <label for="style1-radio" class="text-sm font-medium text-gray-700 cursor-pointer">
                                Style 1: Detailed Line Items (Show all individual items from CSV)
                            </label>
                        </div>
                        <div class="flex items-center gap-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <input 
                                type="radio" 
                                id="style2-radio" 
                                name="invoice-style" 
                                value="style2"
                                class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500"
                                onchange="toggleStyleOptions()"
                            >
                            <label for="style2-radio" class="text-sm font-medium text-gray-700 cursor-pointer">
                                Style 2: Simplified (Single line item with total)
                            </label>
                        </div>
                        <div id="style2-options" class="hidden ml-9 p-4 bg-white border border-blue-200 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Item Name (for Style 2)</label>
                            <textarea 
                                id="item-name-input" 
                                rows="3"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2"
                                placeholder="Leave empty to use client name. Press Enter for new lines."
                            ></textarea>
                            <p class="mt-2 text-xs text-gray-500">This will be displayed as the line item description. If left empty, the client name will be used.</p>
                        </div>
                    </div>
                </div>

                <!-- Pricing Configuration -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Pricing Configuration</h3>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Job Price (Flat) £</label>
                                <input type="number" step="0.01" id="job-price-flat" value="" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mileage Included</label>
                                <input type="number" step="0.01" id="mileage-included" value="" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mileage Charge £</label>
                                <input type="number" step="0.01" id="mileage-charge" value="" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            </div>
                        </div>
                        <div class="mt-4 flex gap-4 items-center">
                            <button 
                                type="button"
                                id="calculate-totals-btn"
                                onclick="calculateSelectedTotals()"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200"
                            >
                                Calculate Selected Totals
                            </button>
                            <span id="selected-count" class="text-sm text-gray-600">0 items selected</span>
                        </div>
                        <p class="mt-2 text-xs text-gray-600">
                            Formula: Job Price + (if Actual Mileage > Mileage Included: (Actual Mileage - Mileage Included) × Mileage Charge, else: 0)
                        </p>
                    </div>
                </div>

                <!-- Invoice Line Items -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Invoice Line Items</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border border-gray-300 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b">
                                        <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()" class="cursor-pointer">
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b cursor-pointer hover:bg-gray-100 select-none" onclick="sortTable('date')">
                                        Date <span id="sort-date-indicator" class="ml-1 text-gray-400"></span>
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b">Our Ref</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b">Client Ref</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b cursor-pointer hover:bg-gray-100 select-none" onclick="sortTable('mob')">
                                        MOB <span id="sort-mob-indicator" class="ml-1 text-gray-400"></span>
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b cursor-pointer hover:bg-gray-100 select-none" onclick="sortTable('miles')">
                                        Miles <span id="sort-miles-indicator" class="ml-1 text-gray-400"></span>
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b">Wait £</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b">Miles £</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b">Job £</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b">Total</th>
                                </tr>
                            </thead>
                            <tbody id="invoice-items-table">
                                <!-- Invoice items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Paid Stamp Option -->
                <div class="mb-8">
                    <div class="flex items-center gap-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <input 
                            type="checkbox" 
                            id="paid-stamp-checkbox" 
                            class="w-5 h-5 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500"
                        >
                        <label for="paid-stamp-checkbox" class="text-sm font-medium text-gray-700 cursor-pointer">
                            Mark Invoice as Paid (Add "PAID" stamp to first page)
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4">
                    <button 
                        type="button"
                        id="preview-btn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200"
                    >
                        Preview Invoice
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200"
                    >
                        Generate & Download Invoice
                    </button>
                </div>
            </form>
        </div>

        <!-- Success Message -->
        <div id="success" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mt-6">
            <p class="text-green-800 text-sm mb-2">Invoice generated successfully!</p>
            <a id="download-link" href="#" download class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                Download HTML Invoice
            </a>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let currentInvoiceData = null;
        let currentInvoiceItems = null;
        let originalInvoiceItems = null;
        let sortState = { order: [] }; // Array of { column, direction }
        let isDragging = false;
        let dragStartIndex = null;
        let dragStartChecked = null;
        let mouseDownTime = null;
        let mouseDownPosition = null;
        let currentMousePosition = null;

        // Handle HTML upload
        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const fileInput = document.getElementById('html_file');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showError('Please select an HTML file');
                return;
            }
            
            formData.append('file', fileInput.files[0]);
            
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            
            try {
                const response = await fetch('/api/upload-html', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Processing failed');
                }
                
                const data = await response.json();
                currentSessionId = data.session_id;
                currentInvoiceData = data.invoice_data;
                
                // Load the invoice
                populateForm(data.invoice_data);
                document.getElementById('current-invoice-name').textContent = data.filename;
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('editing-section').classList.remove('hidden');
                
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('upload-section').classList.remove('hidden');
                showError(error.message);
            }
        });


        // Helper function to format our_ref (remove .0 suffix)
        function formatOurRef(ref) {
            if (!ref) return '';
            const refStr = String(ref).trim();
            if (refStr.endsWith('.0')) {
                return refStr.slice(0, -2);
            }
            return refStr;
        }

        // Helper function to format miles (convert nan to 0.0)
        function formatMiles(miles) {
            if (!miles) return '0.0';
            const milesStr = String(miles).trim().toLowerCase();
            if (milesStr === 'nan' || milesStr === '' || milesStr === 'null' || milesStr === 'undefined') {
                return '0.0';
            }
            return milesStr;
        }

        // Helper function to format miles for calculation (convert nan to 0)
        function formatMilesForCalculation(miles) {
            if (!miles) return 0;
            const milesStr = String(miles).trim().toLowerCase();
            if (milesStr === 'nan' || milesStr === '' || milesStr === 'null' || milesStr === 'undefined') {
                return 0;
            }
            return parseFloat(milesStr) || 0;
        }
        
        function populateForm(data) {
            document.getElementById('patient-name').value = data.patient.name || '';
            document.getElementById('patient-address').value = data.patient.address || '';
            document.getElementById('patient-postcode').value = data.patient.postcode || '';
            document.getElementById('invoice-number').value = data.invoice.number || '';
            document.getElementById('invoice-date').value = data.invoice.date || '';
            document.getElementById('account-ref').value = data.invoice.account_ref || '';
            document.getElementById('ref').value = data.invoice.ref || '';
            document.getElementById('po-number').value = data.invoice.po_number || '';
            document.getElementById('payment-terms').value = data.invoice.payment_terms || '';
            document.getElementById('period').value = data.invoice.period || '';
            document.getElementById('net-label').value = data.financial.net_label || 'net';
            document.getElementById('net').value = data.financial.net || '';
            document.getElementById('discount-label').value = data.financial.discount_label || 'discount';
            document.getElementById('discount').value = data.financial.discount || '';
            document.getElementById('subtotal-label').value = data.financial.subtotal_label || 'Invoice subtotal';
            document.getElementById('subtotal').value = data.financial.subtotal || '';
            document.getElementById('vat-label').value = data.financial.vat_label || 'VAT';
            document.getElementById('vat-percentage').value = data.financial.vat_percentage || '20';
            document.getElementById('vat-amount').value = data.financial.vat_amount || '';
            document.getElementById('total-label').value = data.financial.total_label || 'TOTAL DUE';
            document.getElementById('total').value = data.financial.total || '';
            // Calculate subtotal, VAT, and total after populating form
            calculateSubtotalAndVAT();
            // Bank details are static - always use these values
            document.getElementById('bank-name').value = 'Lloyds Bank Plc';
            document.getElementById('bank-account-name').value = 'Starcross Trading Limited';
            document.getElementById('bank-account-number').value = '82082760';
            document.getElementById('bank-sort-code').value = '30-99-21';
            // Paid stamp checkbox
            document.getElementById('paid-stamp-checkbox').checked = data.paid || false;
            // Invoice style
            const style = data.style || 'style1';
            if (style === 'style2') {
                document.getElementById('style2-radio').checked = true;
            } else {
                document.getElementById('style1-radio').checked = true;
            }
            toggleStyleOptions();
            // Item name for Style 2
            document.getElementById('item-name-input').value = data.item_name || '';
            
            // Store original invoice items for sorting (keep original order)
            originalInvoiceItems = JSON.parse(JSON.stringify(data.invoice.items));
            currentInvoiceItems = data.invoice.items;
            
            // Reset sort state when loading new data
            sortState = { order: [] };
            updateSortIndicators();
            
            // Populate invoice items table
            populateInvoiceItemsTable(currentInvoiceItems);
        }
        
        function updateRowTotal(index) {
            const waitInput = document.querySelector(`.item-wait-pounds[data-index="${index}"]`);
            const milesInput = document.querySelector(`.item-miles-pounds[data-index="${index}"]`);
            const jobInput = document.querySelector(`.item-job-pounds[data-index="${index}"]`);
            const totalInput = document.querySelector(`.item-total[data-index="${index}"]`);
            
            if (waitInput && milesInput && jobInput && totalInput) {
                const wait = parseFloat(waitInput.value) || 0;
                const miles = parseFloat(milesInput.value) || 0;
                const job = parseFloat(jobInput.value) || 0;
                const total = wait + miles + job;
                totalInput.value = total.toFixed(2);
            }
        }
        
        function calculateSubtotalAndVAT() {
            // Calculate subtotal = net - discount
            const net = parseFloat(document.getElementById('net').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const subtotal = net - discount;
            
            // Update subtotal field
            const subtotalField = document.getElementById('subtotal');
            if (subtotalField) {
                subtotalField.value = subtotal.toFixed(2);
            }
            
            // Calculate VAT
            calculateVAT();
        }
        
        function calculateVAT() {
            // Get subtotal (calculate if needed)
            const subtotalField = document.getElementById('subtotal');
            const subtotal = parseFloat(subtotalField ? subtotalField.value : 0) || 0;
            
            // Get VAT percentage
            const vatPercentage = parseFloat(document.getElementById('vat-percentage').value) || 0;
            
            // Calculate VAT = subtotal × (percentage / 100)
            const vatAmount = subtotal * (vatPercentage / 100);
            
            // Update VAT amount field
            const vatAmountField = document.getElementById('vat-amount');
            if (vatAmountField) {
                vatAmountField.value = vatAmount.toFixed(2);
            }
            
            // Calculate total = subtotal + VAT
            const total = subtotal + vatAmount;
            
            // Update total field
            const totalField = document.getElementById('total');
            if (totalField) {
                totalField.value = total.toFixed(2);
            }
        }
        
        // Make functions globally accessible
        window.calculateSubtotalAndVAT = calculateSubtotalAndVAT;
        window.calculateVAT = calculateVAT;
        
        function populateInvoiceItemsTable(items) {
            // Filter out items where both date and our_ref are 'nan' or empty
            const filteredItems = items.filter(item => {
                const dateIsNan = !item.date || item.date.toLowerCase() === 'nan' || item.date.trim() === '';
                const refIsNan = !item.our_ref || item.our_ref.toLowerCase() === 'nan' || item.our_ref.trim() === '';
                return !(dateIsNan && refIsNan);
            });
            
            // Update current items (for display) - use filtered items
            currentInvoiceItems = filteredItems;
            
            const tbody = document.getElementById('invoice-items-table');
            tbody.innerHTML = '';
            
            filteredItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.id = `invoice-row-${index}`;
                row.setAttribute('data-index', index);
                
                // Add drag selection event listeners to the entire row
                // But exclude the checkbox itself - checkbox is for individual selection
                row.addEventListener('mousedown', (e) => {
                    // Don't start drag if clicking directly on the checkbox - let it work normally
                    if (e.target.type === 'checkbox') {
                        return; // Let checkbox handle its own click
                    }
                    
                    // Start drag for clicks anywhere else on the row
                    mouseDownTime = Date.now();
                    mouseDownPosition = { x: e.clientX, y: e.clientY };
                    const checkbox = row.querySelector('.item-checkbox');
                    if (checkbox) {
                        dragStartIndex = index;
                        dragStartChecked = !checkbox.checked; // Target state (opposite of current)
                    }
                });
                
                row.addEventListener('mousemove', (e) => {
                    currentMousePosition = { x: e.clientX, y: e.clientY };
                });
                
                row.addEventListener('mouseenter', (e) => {
                    currentMousePosition = { x: e.clientX, y: e.clientY };
                    
                    // Check if we should start dragging (mouse moved while button is down)
                    if (mouseDownTime !== null && dragStartIndex !== null && !isDragging) {
                        const timeSinceMouseDown = Date.now() - mouseDownTime;
                        const distance = mouseDownPosition && currentMousePosition ? 
                            Math.sqrt(Math.pow(currentMousePosition.x - mouseDownPosition.x, 2) + 
                                     Math.pow(currentMousePosition.y - mouseDownPosition.y, 2)) : 0;
                        
                        // Start dragging if mouse moved more than 5px or held for more than 100ms
                        if (distance > 5 || timeSinceMouseDown > 100) {
                            isDragging = true;
                            const checkbox = document.querySelector(`.item-checkbox[data-index="${dragStartIndex}"]`);
                            if (checkbox) {
                                checkbox.checked = dragStartChecked;
                                updateRowSelection(dragStartIndex, dragStartChecked);
                            }
                        }
                    }
                    
                    if (isDragging && dragStartIndex !== null) {
                        // Select all rows between dragStartIndex and current index
                        const start = Math.min(dragStartIndex, index);
                        const end = Math.max(dragStartIndex, index);
                        
                        for (let i = start; i <= end; i++) {
                            updateRowSelection(i, dragStartChecked);
                        }
                    }
                });
                
                row.innerHTML = `
                    <td class="px-4 py-2">
                        <input type="checkbox" 
                               class="item-checkbox cursor-pointer" 
                               data-index="${index}"
                               checked
                               onchange="updateSelectedCount()">
                    </td>
                    <td class="px-4 py-2 text-sm text-gray-700">${item.date || ''}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${formatOurRef(item.our_ref || '')}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${item.client_ref || ''}</td>
                    <td class="px-4 py-2 text-sm text-gray-700 font-medium">${item.mob || ''}</td>
                    <td class="px-4 py-2 text-sm text-gray-600">${formatMiles(item.miles)}</td>
                    <td class="px-4 py-2">
                        <input type="number" step="0.01" 
                               class="item-wait-pounds w-full border border-gray-300 rounded px-2 py-1 text-sm" 
                               data-index="${index}" 
                               value="${item.wait_pounds || ''}"
                               oninput="updateRowTotal(${index})">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" step="0.01" 
                               class="item-miles-pounds w-full border border-gray-300 rounded px-2 py-1 text-sm" 
                               data-index="${index}" 
                               value="${item.miles_pounds || ''}"
                               oninput="updateRowTotal(${index})">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" step="0.01" 
                               class="item-job-pounds w-full border border-gray-300 rounded px-2 py-1 text-sm" 
                               data-index="${index}" 
                               value="${item.job_pounds || ''}"
                               oninput="updateRowTotal(${index})">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" step="0.01" 
                               class="item-total w-full border border-gray-300 rounded px-2 py-1 text-sm font-semibold" 
                               data-index="${index}" 
                               data-actual-mileage="${formatMilesForCalculation(item.miles)}"
                               value="${item.total || ''}">
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Make updateRowTotal globally accessible
            window.updateRowTotal = updateRowTotal;
            
            // Initialize selected count
            updateSelectedCount();
        }
        
        // Add global mouseup and mousemove listeners once to stop dragging
        if (!window.dragListenerAdded) {
            document.addEventListener('mouseup', stopDragging);
            document.addEventListener('mousemove', (e) => {
                currentMousePosition = { x: e.clientX, y: e.clientY };
            });
            window.dragListenerAdded = true;
        }
        
        // Removed handleCheckboxMouseDown - checkboxes now work normally for individual selection
        // Drag selection is handled by the row mousedown event
        
        function updateRowSelection(index, checked) {
            const checkbox = document.querySelector(`.item-checkbox[data-index="${index}"]`);
            const row = document.getElementById(`invoice-row-${index}`);
            
            if (checkbox) {
                checkbox.checked = checked;
            }
            
            if (row) {
                if (checked) {
                    row.classList.add('bg-blue-50');
                } else {
                    row.classList.remove('bg-blue-50');
                }
            }
        }
        
        function stopDragging() {
            // If it was a quick click (not a drag), toggle the checkbox
            if (mouseDownTime !== null && !isDragging && dragStartIndex !== null) {
                const timeSinceMouseDown = Date.now() - mouseDownTime;
                const distance = mouseDownPosition && currentMousePosition ? 
                    Math.sqrt(Math.pow(currentMousePosition.x - mouseDownPosition.x, 2) + 
                             Math.pow(currentMousePosition.y - mouseDownPosition.y, 2)) : 0;
                
                // If it was a quick click with minimal movement, toggle the checkbox
                if (timeSinceMouseDown < 300 && distance < 10) {
                    const checkbox = document.querySelector(`.item-checkbox[data-index="${dragStartIndex}"]`);
                    if (checkbox) {
                        checkbox.checked = dragStartChecked;
                        updateRowSelection(dragStartIndex, dragStartChecked);
                        updateSelectedCount();
                    }
                }
            }
            
            if (isDragging) {
                updateSelectedCount();
            }
            
            isDragging = false;
            dragStartIndex = null;
            dragStartChecked = null;
            mouseDownTime = null;
            mouseDownPosition = null;
            currentMousePosition = null;
        }
        
        window.sortTable = function(column) {
            if (!originalInvoiceItems || originalInvoiceItems.length === 0) return;
            
            // Multi-level sorting: track multiple sort criteria
            // Check if column is already in sort order
            const existingIndex = sortState.order.findIndex(s => s.column === column);
            
            if (existingIndex >= 0) {
                // Column already in sort order - toggle direction or remove
                const currentSort = sortState.order[existingIndex];
                if (currentSort.direction === 'asc') {
                    // Change to desc
                    sortState.order[existingIndex].direction = 'desc';
                } else {
                    // Remove from sort order
                    sortState.order.splice(existingIndex, 1);
                }
            } else {
                // Add new column to sort order
                sortState.order.push({ column: column, direction: 'asc' });
            }
            
            // Create a deep copy of original items to sort (always sort from original)
            const sortedItems = JSON.parse(JSON.stringify(originalInvoiceItems));
            
            // Multi-level sort: apply all sort criteria in order
            sortedItems.sort((a, b) => {
                for (let i = 0; i < sortState.order.length; i++) {
                    const sortCriteria = sortState.order[i];
                    const column = sortCriteria.column;
                    const direction = sortCriteria.direction;
                    
                    let aVal, bVal;
                    
                    if (column === 'date') {
                        // Parse dates for comparison
                        aVal = a.date ? new Date(a.date) : new Date(0);
                        bVal = b.date ? new Date(b.date) : new Date(0);
                    } else if (column === 'mob') {
                        // Alphabetical sorting for MOB
                        aVal = (a.mob || '').toLowerCase();
                        bVal = (b.mob || '').toLowerCase();
                    } else if (column === 'miles') {
                        // Numeric sorting for miles
                        aVal = formatMilesForCalculation(a.miles);
                        bVal = formatMilesForCalculation(b.miles);
                    } else {
                        continue; // Skip unknown columns
                    }
                    
                    // Compare values
                    if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                    // If equal, continue to next sort criteria
                }
                return 0; // All criteria are equal
            });
            
            // Update indicators
            updateSortIndicators();
            
            // Re-render table with sorted items
            populateInvoiceItemsTable(sortedItems);
        }
        
        function updateSortIndicators() {
            // Reset all indicators
            document.getElementById('sort-date-indicator').textContent = '';
            document.getElementById('sort-mob-indicator').textContent = '';
            document.getElementById('sort-miles-indicator').textContent = '';
            
            // Update indicators based on sort order
            sortState.order.forEach((sortCriteria, index) => {
                const indicator = sortCriteria.direction === 'asc' ? '↑' : '↓';
                const orderNumber = sortState.order.length > 1 ? `${index + 1}` : '';
                const fullIndicator = orderNumber + indicator;
                
                if (sortCriteria.column === 'date') {
                    document.getElementById('sort-date-indicator').textContent = fullIndicator;
                } else if (sortCriteria.column === 'mob') {
                    document.getElementById('sort-mob-indicator').textContent = fullIndicator;
                } else if (sortCriteria.column === 'miles') {
                    document.getElementById('sort-miles-indicator').textContent = fullIndicator;
                }
            });
        }
        
        window.toggleSelectAll = function() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const itemCheckboxes = document.querySelectorAll('.item-checkbox');
            const isChecked = selectAllCheckbox.checked;
            
            itemCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                const row = document.getElementById(`invoice-row-${checkbox.getAttribute('data-index')}`);
                if (row) {
                    if (isChecked) {
                        row.classList.add('bg-blue-50');
                    } else {
                        row.classList.remove('bg-blue-50');
                    }
                }
            });
            
            updateSelectedCount();
        };
        
        window.updateSelectedCount = function() {
            const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
            const count = selectedCheckboxes.length;
            const countElement = document.getElementById('selected-count');
            
            if (countElement) {
                countElement.textContent = `${count} item${count !== 1 ? 's' : ''} selected`;
            }
            
            // Update row highlighting
            document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                const index = checkbox.getAttribute('data-index');
                const row = document.getElementById(`invoice-row-${index}`);
                
                if (row) {
                    if (checkbox.checked) {
                        row.classList.add('bg-blue-50');
                    } else {
                        row.classList.remove('bg-blue-50');
                    }
                }
            });
            
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.item-checkbox');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox && allCheckboxes.length > 0) {
                const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = someChecked && !allChecked;
            }
        };
        
        window.calculateSelectedTotals = function() {
            const jobPrice = parseFloat(document.getElementById('job-price-flat').value) || 0;
            const mileageIncluded = parseFloat(document.getElementById('mileage-included').value) || 0;
            const mileageCharge = parseFloat(document.getElementById('mileage-charge').value) || 0;
            
            if (!jobPrice) {
                alert('Please enter a Job Price (Flat) first');
                return;
            }
            
            // Get selected checkboxes
            const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one item to calculate');
                return;
            }
            
            // Process only selected items
            selectedCheckboxes.forEach(checkbox => {
                const index = checkbox.getAttribute('data-index');
                
                // Set job_pounds for this item
                const jobPoundsInput = document.querySelector(`.item-job-pounds[data-index="${index}"]`);
                if (jobPoundsInput) {
                    jobPoundsInput.value = jobPrice.toFixed(2);
                }
                
                // Get actual mileage
                const totalInput = document.querySelector(`.item-total[data-index="${index}"]`);
                if (!totalInput) return;
                
                const actualMileage = parseFloat(totalInput.getAttribute('data-actual-mileage')) || 0;
                
                // Calculate mileage charge amount
                let milesChargeAmount = 0;
                let extraMilesRounded = 0;
                if (actualMileage > mileageIncluded) {
                    const extraMiles = actualMileage - mileageIncluded;
                    // Round up to the next whole integer
                    extraMilesRounded = Math.ceil(extraMiles);
                    milesChargeAmount = extraMilesRounded * mileageCharge;
                }
                
                // Update miles_pounds with the calculated mileage charge
                const milesPoundsInput = document.querySelector(`.item-miles-pounds[data-index="${index}"]`);
                if (milesPoundsInput) {
                    milesPoundsInput.value = milesChargeAmount.toFixed(2);
                }
                
                // Update the "charged" field in the invoice item data with the rounded miles
                if (currentInvoiceItems && currentInvoiceItems[index]) {
                    currentInvoiceItems[index].charged = extraMilesRounded > 0 ? extraMilesRounded.toString() : '0';
                }
                
                // Update the total for this row (Wait + Miles + Job)
                updateRowTotal(index);
            });
        };
        

        // Handle preview
        document.getElementById('preview-btn').addEventListener('click', async () => {
            if (!currentSessionId) return;
            
            // Check if at least one item is selected
            const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showError('Please select at least one line item to preview');
                return;
            }
            
            const formData = collectFormData();
            const formDataToSend = new FormData();
            formDataToSend.append('session_id', currentSessionId);
            formDataToSend.append('invoice_data_json', JSON.stringify(formData));
            
            try {
                const response = await fetch('/api/update-invoice', {
                    method: 'POST',
                    body: formDataToSend
                });
                
                if (!response.ok) throw new Error('Preview failed');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                window.open(url, '_blank');
                window.URL.revokeObjectURL(url);
            } catch (error) {
                showError('Failed to generate preview');
            }
        });

        // Handle form submission
        document.getElementById('invoice-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentSessionId) {
                showError('Please upload an HTML invoice file first');
                return;
            }
            
            // Check if at least one item is selected
            const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showError('Please select at least one line item to include in the invoice');
                return;
            }
            
            const formData = collectFormData();
            
            const formDataToSend = new FormData();
            formDataToSend.append('session_id', currentSessionId);
            formDataToSend.append('invoice_data_json', JSON.stringify(formData));
            
            try {
                const response = await fetch('/api/update-invoice', {
                    method: 'POST',
                    body: formDataToSend
                });
                
                if (!response.ok) throw new Error('Generation failed');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const currentFilename = document.getElementById('current-invoice-name').textContent || 'invoice';
                a.download = currentFilename.endsWith('.html') ? currentFilename : currentFilename + '.html';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                document.getElementById('success').classList.remove('hidden');
            } catch (error) {
                showError('Failed to generate invoice');
            }
        });

        function collectFormData() {
            // Filter out items where both date and our_ref are 'nan' or empty
            const validItems = currentInvoiceData.invoice.items.filter(item => {
                const dateIsNan = !item.date || item.date.toLowerCase() === 'nan' || String(item.date).trim() === '';
                const refIsNan = !item.our_ref || item.our_ref.toLowerCase() === 'nan' || String(item.our_ref).trim() === '';
                return !(dateIsNan && refIsNan);
            });
            
            // Collect updated invoice items with edited financial values
            // Only include items that are selected (checkbox checked) and displayed in the table
            const updatedItems = currentInvoiceItems
                .map((item, index) => {
                    // Check if this item's checkbox is selected
                    const checkbox = document.querySelector(`.item-checkbox[data-index="${index}"]`);
                    const isSelected = checkbox ? checkbox.checked : false;
                    
                    // If not selected, return null (will be filtered out)
                    if (!isSelected) {
                        return null;
                    }
                    
                    const waitPoundsInput = document.querySelector(`.item-wait-pounds[data-index="${index}"]`);
                    const milesPoundsInput = document.querySelector(`.item-miles-pounds[data-index="${index}"]`);
                    const jobPoundsInput = document.querySelector(`.item-job-pounds[data-index="${index}"]`);
                    const totalInput = document.querySelector(`.item-total[data-index="${index}"]`);
                    
                    return {
                        ...item,
                        wait_pounds: waitPoundsInput ? waitPoundsInput.value : item.wait_pounds,
                        miles_pounds: milesPoundsInput ? milesPoundsInput.value : item.miles_pounds,
                        job_pounds: jobPoundsInput ? jobPoundsInput.value : item.job_pounds,
                        total: totalInput ? totalInput.value : item.total,
                        charged: item.charged || '0'  // Ensure charged field is always present
                    };
                })
                .filter(item => item !== null); // Remove null items (unselected)
            
            // Calculate total based on invoice style
            const selectedStyle = document.querySelector('input[name="invoice-style"]:checked').value;
            let calculatedTotal = document.getElementById('total').value;
            
            if (selectedStyle === 'style1') {
                // Style 1: Sum all non-zero totals from selected line items
                let sum = 0;
                updatedItems.forEach(item => {
                    const itemTotal = parseFloat(item.total) || 0;
                    if (itemTotal > 0) {
                        sum += itemTotal;
                    }
                });
                calculatedTotal = sum.toFixed(2);
            } else if (selectedStyle === 'style2') {
                // Style 2: Use the total from financial section (subtotal + VAT)
                // This is already calculated by calculateVAT() function
                // If no line items or sum is 0, use the manually entered total
                const totalField = document.getElementById('total');
                calculatedTotal = totalField ? totalField.value : '0.00';
            }
            
            return {
                patient: {
                    name: document.getElementById('patient-name').value,
                    address: document.getElementById('patient-address').value,
                    postcode: document.getElementById('patient-postcode').value
                },
                invoice: {
                    ...currentInvoiceData.invoice,
                    number: document.getElementById('invoice-number').value,
                    date: document.getElementById('invoice-date').value,
                    account_ref: document.getElementById('account-ref').value,
                    ref: document.getElementById('ref').value,
                    po_number: document.getElementById('po-number').value,
                    payment_terms: document.getElementById('payment-terms').value,
                    period: document.getElementById('period').value,
                    items: updatedItems
                },
                financial: {
                    net: document.getElementById('net').value,
                    net_label: document.getElementById('net-label').value,
                    discount: document.getElementById('discount').value,
                    discount_label: document.getElementById('discount-label').value,
                    subtotal: document.getElementById('subtotal').value,
                    subtotal_label: document.getElementById('subtotal-label').value,
                    vat_amount: document.getElementById('vat-amount').value,
                    vat_label: document.getElementById('vat-label').value,
                    vat_percentage: document.getElementById('vat-percentage').value,
                    total: calculatedTotal,
                    total_label: document.getElementById('total-label').value
                },
                bank: {
                    name: 'Lloyds Bank Plc',
                    account_name: 'Starcross Trading Limited',
                    account_number: '82082760',
                    sort_code: '30-99-21'
                },
                paid: document.getElementById('paid-stamp-checkbox').checked,
                style: selectedStyle,
                item_name: document.getElementById('item-name-input').value
            };
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function toggleStyleOptions() {
            const style2Radio = document.getElementById('style2-radio');
            const style2Options = document.getElementById('style2-options');
            if (style2Radio.checked) {
                style2Options.classList.remove('hidden');
            } else {
                style2Options.classList.add('hidden');
            }
        }

        // Make toggleStyleOptions globally accessible
        window.toggleStyleOptions = toggleStyleOptions;
        
        // Handle back to previous page
        const backToPreviousBtn = document.getElementById('back-to-previous-btn');
        const previousPageData = sessionStorage.getItem('previousPage');
        
        if (previousPageData) {
            try {
                const data = JSON.parse(previousPageData);
                backToPreviousBtn.href = data.url;
                backToPreviousBtn.classList.remove('hidden');
                
                backToPreviousBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Restore previous page state if needed
                    if (data.state) {
                        sessionStorage.setItem('restoreState', JSON.stringify(data.state));
                    }
                    window.location.href = data.url;
                });
            } catch (e) {
                console.error('Failed to parse previous page data:', e);
                // If parsing fails, default to home
                backToPreviousBtn.href = '/';
                backToPreviousBtn.classList.remove('hidden');
            }
        } else {
            // No previous page data - default to home page
            backToPreviousBtn.href = '/';
            backToPreviousBtn.classList.remove('hidden');
        }
    </script>
</body>
</html>

